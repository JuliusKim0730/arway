---
title: "3.00 백엔드 API 서버 구축"
type: "implementation"
tags: ["backend", "api", "fastapi", "rest", "crud"]
dependencies: ["fastapi", "uvicorn", "sqlalchemy", "pydantic"]
---

# 3.00 백엔드 API 서버 구축

## 워크플로우 개요

FastAPI를 사용하여 RESTful API 서버를 구축하고, 모든 엔드포인트를 구현합니다.

## 목표

- FastAPI 애플리케이션 초기화
- API 라우터 구조 설정
- CRUD 엔드포인트 구현
- 요청/응답 스키마 정의
- 에러 핸들링 구현

## 단계별 작업

### 3.1 FastAPI 앱 초기화

#### 3.1.1 메인 앱 설정
`backend/app/main.py`:
```python
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from app.api.v1 import users, destinations, sessions, navigation_points, feedback, analytics
from app.database import engine, Base

# 데이터베이스 테이블 생성
Base.metadata.create_all(bind=engine)

app = FastAPI(
    title="ARWay Lite API",
    version="0.1.0",
    description="SCQ 기반 AR 도보 네비게이션 MVP API"
)

# CORS 설정
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000"],  # Frontend URL
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# API 라우터 등록
app.include_router(users.router, prefix="/api/v1/users", tags=["users"])
app.include_router(destinations.router, prefix="/api/v1/destinations", tags=["destinations"])
app.include_router(sessions.router, prefix="/api/v1/sessions", tags=["sessions"])
app.include_router(navigation_points.router, prefix="/api/v1/navigation-points", tags=["navigation-points"])
app.include_router(feedback.router, prefix="/api/v1/feedback", tags=["feedback"])
app.include_router(analytics.router, prefix="/api/v1/analytics", tags=["analytics"])

@app.get("/")
async def root():
    return {"message": "ARWay Lite API", "version": "0.1.0"}

@app.get("/health")
async def health_check():
    return {"status": "healthy"}
```

### 3.2 Pydantic 스키마 정의

#### 3.2.1 공통 스키마
`backend/app/schemas/common.py`:
```python
from pydantic import BaseModel
from datetime import datetime
from uuid import UUID
from decimal import Decimal

class TimestampMixin(BaseModel):
    created_at: datetime
    updated_at: datetime

class LocationBase(BaseModel):
    latitude: Decimal
    longitude: Decimal
```

#### 3.2.2 Destination 스키마
`backend/app/schemas/destination.py`:
```python
from pydantic import BaseModel
from decimal import Decimal
from uuid import UUID
from typing import Optional

class DestinationBase(BaseModel):
    name: str
    description: Optional[str] = None
    latitude: Decimal
    longitude: Decimal
    address: Optional[str] = None
    is_active: bool = True

class DestinationCreate(DestinationBase):
    created_by: UUID

class DestinationUpdate(BaseModel):
    name: Optional[str] = None
    description: Optional[str] = None
    latitude: Optional[Decimal] = None
    longitude: Optional[Decimal] = None
    address: Optional[str] = None
    is_active: Optional[bool] = None

class DestinationResponse(DestinationBase):
    id: UUID
    created_by: UUID
    created_at: datetime
    updated_at: datetime
    
    class Config:
        from_attributes = True
```

#### 3.2.3 Session 스키마
`backend/app/schemas/session.py`:
```python
from pydantic import BaseModel
from decimal import Decimal
from uuid import UUID
from datetime import datetime
from typing import Optional

class SessionCreate(BaseModel):
    user_id: UUID
    destination_id: UUID
    start_latitude: Decimal
    start_longitude: Decimal

class SessionUpdate(BaseModel):
    end_latitude: Optional[Decimal] = None
    end_longitude: Optional[Decimal] = None
    status: Optional[str] = None
    total_distance: Optional[Decimal] = None

class SessionResponse(BaseModel):
    id: UUID
    user_id: UUID
    destination_id: UUID
    start_latitude: Optional[Decimal]
    start_longitude: Optional[Decimal]
    end_latitude: Optional[Decimal]
    end_longitude: Optional[Decimal]
    status: str
    started_at: datetime
    completed_at: Optional[datetime]
    total_distance: Optional[Decimal]
    
    class Config:
        from_attributes = True
```

#### 3.2.4 NavigationPoint 스키마
`backend/app/schemas/navigation_point.py`:
```python
from pydantic import BaseModel
from decimal import Decimal
from uuid import UUID
from datetime import datetime
from typing import Optional

class NavigationPointCreate(BaseModel):
    session_id: UUID
    latitude: Decimal
    longitude: Decimal
    heading: Optional[Decimal] = None
    accuracy: Optional[Decimal] = None
    distance_to_target: Optional[Decimal] = None
    bearing: Optional[Decimal] = None
    relative_angle: Optional[Decimal] = None

class NavigationPointResponse(BaseModel):
    id: UUID
    session_id: UUID
    latitude: Decimal
    longitude: Decimal
    heading: Optional[Decimal]
    accuracy: Optional[Decimal]
    distance_to_target: Optional[Decimal]
    bearing: Optional[Decimal]
    relative_angle: Optional[Decimal]
    recorded_at: datetime
    
    class Config:
        from_attributes = True
```

### 3.3 API 라우터 구현

#### 3.3.1 Destinations API
`backend/app/api/v1/destinations.py`:
```python
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List
from app.database import get_db
from app import models, schemas

router = APIRouter()

@router.get("/", response_model=List[schemas.destination.DestinationResponse])
def get_destinations(skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):
    destinations = db.query(models.Destination).filter(
        models.Destination.is_active == True
    ).offset(skip).limit(limit).all()
    return destinations

@router.get("/{destination_id}", response_model=schemas.destination.DestinationResponse)
def get_destination(destination_id: str, db: Session = Depends(get_db)):
    destination = db.query(models.Destination).filter(
        models.Destination.id == destination_id
    ).first()
    if not destination:
        raise HTTPException(status_code=404, detail="Destination not found")
    return destination

@router.post("/", response_model=schemas.destination.DestinationResponse)
def create_destination(
    destination: schemas.destination.DestinationCreate,
    db: Session = Depends(get_db)
):
    db_destination = models.Destination(**destination.dict())
    db.add(db_destination)
    db.commit()
    db.refresh(db_destination)
    return db_destination
```

#### 3.3.2 Sessions API
`backend/app/api/v1/sessions.py`:
```python
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List
from app.database import get_db
from app import models, schemas

router = APIRouter()

@router.post("/", response_model=schemas.session.SessionResponse)
def create_session(
    session: schemas.session.SessionCreate,
    db: Session = Depends(get_db)
):
    db_session = models.NavigationSession(**session.dict())
    db.add(db_session)
    db.commit()
    db.refresh(db_session)
    return db_session

@router.get("/{session_id}", response_model=schemas.session.SessionResponse)
def get_session(session_id: str, db: Session = Depends(get_db)):
    session = db.query(models.NavigationSession).filter(
        models.NavigationSession.id == session_id
    ).first()
    if not session:
        raise HTTPException(status_code=404, detail="Session not found")
    return session

@router.patch("/{session_id}", response_model=schemas.session.SessionResponse)
def update_session(
    session_id: str,
    session_update: schemas.session.SessionUpdate,
    db: Session = Depends(get_db)
):
    db_session = db.query(models.NavigationSession).filter(
        models.NavigationSession.id == session_id
    ).first()
    if not db_session:
        raise HTTPException(status_code=404, detail="Session not found")
    
    for key, value in session_update.dict(exclude_unset=True).items():
        setattr(db_session, key, value)
    
    db.commit()
    db.refresh(db_session)
    return db_session
```

#### 3.3.3 Navigation Points API
`backend/app/api/v1/navigation_points.py`:
```python
from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session
from typing import List
from app.database import get_db
from app import models, schemas

router = APIRouter()

@router.post("/", response_model=schemas.navigation_point.NavigationPointResponse)
def create_navigation_point(
    point: schemas.navigation_point.NavigationPointCreate,
    db: Session = Depends(get_db)
):
    db_point = models.NavigationPoint(**point.dict())
    db.add(db_point)
    db.commit()
    db.refresh(db_point)
    return db_point

@router.get("/session/{session_id}", response_model=List[schemas.navigation_point.NavigationPointResponse])
def get_session_points(session_id: str, db: Session = Depends(get_db)):
    points = db.query(models.NavigationPoint).filter(
        models.NavigationPoint.session_id == session_id
    ).order_by(models.NavigationPoint.recorded_at).all()
    return points
```

### 3.4 데이터베이스 의존성

`backend/app/database.py`에 추가:
```python
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()
```

### 3.5 서버 실행

#### 3.5.1 개발 서버 실행
```bash
cd backend
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

#### 3.5.2 API 문서 확인
- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc

## 검증 체크리스트

- [ ] FastAPI 앱 초기화 완료
- [ ] 모든 API 라우터 구현 완료
- [ ] Pydantic 스키마 정의 완료
- [ ] CRUD 작업 구현 완료
- [ ] 에러 핸들링 구현 완료
- [ ] CORS 설정 완료
- [ ] API 문서 자동 생성 확인
- [ ] 모든 엔드포인트 테스트 완료

## 다음 단계

다음 워크플로우: **4.00 프론트엔드 UI 구현 (시작 화면)**

## 참고 자료

- FastAPI 공식 문서: https://fastapi.tiangolo.com/
- Pydantic 문서: https://docs.pydantic.dev/
- RESTful API 설계 가이드: https://restfulapi.net/

