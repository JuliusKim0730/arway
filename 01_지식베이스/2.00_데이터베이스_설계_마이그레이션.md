---
title: "2.00 데이터베이스 설계 및 마이그레이션"
type: "implementation"
tags: ["database", "migration", "sqlalchemy", "alembic", "schema"]
dependencies: ["sqlalchemy", "alembic", "postgresql"]
---

# 2.00 데이터베이스 설계 및 마이그레이션

## 워크플로우 개요

ERD를 기반으로 데이터베이스 스키마를 정의하고, Alembic을 사용하여 마이그레이션을 생성 및 적용합니다.

## 목표

- SQLAlchemy 모델 정의
- Alembic 마이그레이션 파일 생성
- 데이터베이스 스키마 적용
- 초기 시드 데이터 생성

## 단계별 작업

### 2.1 SQLAlchemy 모델 정의

#### 2.1.1 Base 설정
`backend/app/database.py`:
```python
from sqlalchemy import create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker
import os

DATABASE_URL = os.getenv("DATABASE_URL")

engine = create_engine(DATABASE_URL)
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
Base = declarative_base()
```

#### 2.1.2 User 모델
`backend/app/models/user.py`:
```python
from sqlalchemy import Column, String, DateTime
from sqlalchemy.dialects.postgresql import UUID
import uuid
from datetime import datetime
from app.database import Base

class User(Base):
    __tablename__ = "users"
    
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    email = Column(String, unique=True, nullable=False, index=True)
    name = Column(String, nullable=False)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
```

#### 2.1.3 Destination 모델
`backend/app/models/destination.py`:
```python
from sqlalchemy import Column, String, Text, Numeric, Boolean, DateTime, ForeignKey
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship
import uuid
from datetime import datetime
from app.database import Base

class Destination(Base):
    __tablename__ = "destinations"
    
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    name = Column(String, nullable=False)
    description = Column(Text)
    latitude = Column(Numeric(10, 8), nullable=False)
    longitude = Column(Numeric(11, 8), nullable=False)
    address = Column(String)
    is_active = Column(Boolean, default=True)
    created_by = Column(UUID(as_uuid=True), ForeignKey("users.id"))
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    # Relationships
    creator = relationship("User", backref="destinations")
```

#### 2.1.4 NavigationSession 모델
`backend/app/models/navigation_session.py`:
```python
from sqlalchemy import Column, String, Numeric, DateTime, ForeignKey, Enum
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship
import uuid
import enum
from datetime import datetime
from app.database import Base

class SessionStatus(enum.Enum):
    ACTIVE = "active"
    COMPLETED = "completed"
    CANCELLED = "cancelled"

class NavigationSession(Base):
    __tablename__ = "navigation_sessions"
    
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    user_id = Column(UUID(as_uuid=True), ForeignKey("users.id"), nullable=False)
    destination_id = Column(UUID(as_uuid=True), ForeignKey("destinations.id"), nullable=False)
    start_latitude = Column(Numeric(10, 8))
    start_longitude = Column(Numeric(11, 8))
    end_latitude = Column(Numeric(10, 8))
    end_longitude = Column(Numeric(11, 8))
    status = Column(Enum(SessionStatus), default=SessionStatus.ACTIVE)
    started_at = Column(DateTime, default=datetime.utcnow)
    completed_at = Column(DateTime)
    total_distance = Column(Numeric(10, 2))
    
    # Relationships
    user = relationship("User", backref="sessions")
    destination = relationship("Destination", backref="sessions")
    navigation_points = relationship("NavigationPoint", back_populates="session")
```

#### 2.1.5 NavigationPoint 모델
`backend/app/models/navigation_point.py`:
```python
from sqlalchemy import Column, Numeric, DateTime, ForeignKey, Index
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship
import uuid
from datetime import datetime
from app.database import Base

class NavigationPoint(Base):
    __tablename__ = "navigation_points"
    
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    session_id = Column(UUID(as_uuid=True), ForeignKey("navigation_sessions.id"), nullable=False)
    latitude = Column(Numeric(10, 8), nullable=False)
    longitude = Column(Numeric(11, 8), nullable=False)
    heading = Column(Numeric(5, 2))
    accuracy = Column(Numeric(5, 2))
    distance_to_target = Column(Numeric(10, 2))
    bearing = Column(Numeric(5, 2))
    relative_angle = Column(Numeric(5, 2))
    recorded_at = Column(DateTime, default=datetime.utcnow)
    
    # Relationships
    session = relationship("NavigationSession", back_populates="navigation_points")
    
    # Indexes
    __table_args__ = (
        Index('idx_nav_points_session_time', 'session_id', 'recorded_at'),
    )
```

#### 2.1.6 Feedback 모델
`backend/app/models/feedback.py`:
```python
from sqlalchemy import Column, Integer, Text, DateTime, ForeignKey, Index
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship
import uuid
from datetime import datetime
from app.database import Base

class Feedback(Base):
    __tablename__ = "feedback"
    
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    session_id = Column(UUID(as_uuid=True), ForeignKey("navigation_sessions.id"), nullable=False)
    user_id = Column(UUID(as_uuid=True), ForeignKey("users.id"), nullable=False)
    rating = Column(Integer, nullable=False)  # 1-5
    comment = Column(Text)
    created_at = Column(DateTime, default=datetime.utcnow)
    
    # Relationships
    session = relationship("NavigationSession", backref="feedbacks")
    user = relationship("User", backref="feedbacks")
    
    # Indexes
    __table_args__ = (
        Index('idx_feedback_session', 'session_id'),
    )
```

#### 2.1.7 AnalyticsEvent 모델
`backend/app/models/analytics_event.py`:
```python
from sqlalchemy import Column, String, DateTime, ForeignKey, Index
from sqlalchemy.dialects.postgresql import UUID, JSONB
from sqlalchemy.orm import relationship
import uuid
from datetime import datetime
from app.database import Base

class AnalyticsEvent(Base):
    __tablename__ = "analytics_events"
    
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    session_id = Column(UUID(as_uuid=True), ForeignKey("navigation_sessions.id"), nullable=False)
    event_type = Column(String, nullable=False)  # 'arrive', 'heading_update', 'distance_update'
    event_data = Column(JSONB)
    recorded_at = Column(DateTime, default=datetime.utcnow)
    
    # Relationships
    session = relationship("NavigationSession", backref="analytics_events")
    
    # Indexes
    __table_args__ = (
        Index('idx_analytics_session_type_time', 'session_id', 'event_type', 'recorded_at'),
    )
```

### 2.2 Alembic 마이그레이션 생성

#### 2.2.1 Alembic 설정
`alembic/env.py` 수정:
```python
from app.database import Base
from app.models import user, destination, navigation_session, navigation_point, feedback, analytics_event

target_metadata = Base.metadata
```

#### 2.2.2 초기 마이그레이션 생성
```bash
cd backend
alembic revision --autogenerate -m "Initial migration"
```

#### 2.2.3 마이그레이션 적용
```bash
alembic upgrade head
```

### 2.3 시드 데이터 생성

#### 2.3.1 초기 목적지 데이터
`backend/app/database/seeds.py`:
```python
from app.database import SessionLocal
from app.models.destination import Destination
from app.models.user import User
from decimal import Decimal

def seed_initial_data():
    db = SessionLocal()
    try:
        # 테스트 사용자 생성
        test_user = User(
            email="test@arway.com",
            name="Test User"
        )
        db.add(test_user)
        db.commit()
        
        # 테스트 목적지 생성
        destinations = [
            Destination(
                name="테스트 목적지 1",
                description="회사 앞 카페",
                latitude=Decimal("37.511"),
                longitude=Decimal("127.029"),
                address="서울시 강남구",
                created_by=test_user.id,
                is_active=True
            ),
            Destination(
                name="테스트 목적지 2",
                description="역 출구",
                latitude=Decimal("37.5561"),
                longitude=Decimal("126.9723"),
                address="서울시 중구",
                created_by=test_user.id,
                is_active=True
            ),
        ]
        
        for dest in destinations:
            db.add(dest)
        
        db.commit()
        print("시드 데이터 생성 완료")
    except Exception as e:
        db.rollback()
        print(f"시드 데이터 생성 실패: {e}")
    finally:
        db.close()

if __name__ == "__main__":
    seed_initial_data()
```

## 검증 체크리스트

- [ ] 모든 모델 정의 완료
- [ ] 모델 간 관계 설정 완료
- [ ] 인덱스 설정 완료
- [ ] Alembic 마이그레이션 파일 생성 완료
- [ ] 데이터베이스 스키마 적용 완료
- [ ] 시드 데이터 생성 완료
- [ ] 데이터베이스 연결 테스트 완료

## 다음 단계

다음 워크플로우: **3.00 백엔드 API 서버 구축**

## 참고 자료

- SQLAlchemy 문서: https://docs.sqlalchemy.org/
- Alembic 문서: https://alembic.sqlalchemy.org/
- PostgreSQL 인덱스 최적화: https://www.postgresql.org/docs/current/indexes.html

